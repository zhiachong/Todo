<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Command Center</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 20px;
            border-radius: 16px;
            margin-bottom: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header .date {
            opacity: 0.9;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .nav-tab {
            padding: 10px 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .nav-tab.active {
            background: white;
            color: #667eea;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .card h2 {
            font-size: 18px;
            margin-bottom: 12px;
            color: #333;
        }

        /* School Status */
        .school-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .status-dot.school { background: #27ae60; }
        .status-dot.noschool { background: #e74c3c; }

        /* Meals */
        .meal-item {
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
        }

        .meal-item:last-child { border-bottom: none; }

        .day-label {
            font-weight: 600;
            color: #667eea;
        }

        /* Health */
        .health-streak {
            text-align: center;
        }

        .streak-number {
            font-size: 48px;
            font-weight: 700;
            color: #667eea;
        }

        .streak-label {
            color: #666;
        }

        /* Notes */
        .quick-note {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            resize: vertical;
            min-height: 80px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }

        .btn:hover {
            opacity: 0.9;
        }

        /* Todo Styles */
        .input-wrapper {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        #taskInput {
            flex: 1;
            padding: 14px 18px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
        }

        #taskInput:focus {
            outline: none;
            border-color: #667eea;
        }

        .filters {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .filter-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        .filter-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
        }

        .task-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .task {
            display: flex;
            align-items: center;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 12px;
            margin-bottom: 10px;
            transition: all 0.2s;
        }

        .task:hover {
            background: #f0f0f0;
        }

        .task-checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid #667eea;
            border-radius: 50%;
            margin-right: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .task-checkbox.checked {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: transparent;
        }

        .task-checkbox.checked::after {
            content: '‚úì';
            color: white;
            font-size: 14px;
            font-weight: bold;
        }

        .task.completed .task-text {
            text-decoration: line-through;
            color: #999;
        }

        .task-text {
            flex: 1;
            font-size: 16px;
            color: #333;
        }

        .task-delete {
            background: #ff4757;
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            opacity: 0;
            transition: all 0.2s;
        }

        .task:hover .task-delete {
            opacity: 1;
        }

        .todo-stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 15px;
            font-size: 12px;
            color: #666;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìã Family Command Center</h1>
            <div class="date" id="todayDate">Loading...</div>
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showSection('family')">Family</button>
                <button class="nav-tab" onclick="showSection('tasks')">Tasks</button>
            </div>
        </div>

        <!-- Family Section -->
        <div id="family-section" class="section active">
            <div class="card">
                <h2>üè´ School Status</h2>
                <div class="school-status" id="schoolStatus">
                    <div class="status-dot school"></div>
                    <span>Aiden has school today</span>
                </div>
                <div style="margin-top: 12px; font-size: 14px; color: #666;" id="nextEvent">
                    Loading upcoming events...
                </div>
            </div>

            <div class="card">
                <h2>üçΩÔ∏è This Week's Meals</h2>
                <div id="mealPlan">
                    <div class="meal-item">
                        <span class="day-label">Monday</span>
                        <span>Korean Beef Bowl</span>
                    </div>
                    <div class="meal-item">
                        <span class="day-label">Tuesday</span>
                        <span>Miso Glazed Salmon</span>
                    </div>
                    <div class="meal-item">
                        <span class="day-label">Wednesday</span>
                        <span>Chicken Teriyaki</span>
                    </div>
                    <div class="meal-item">
                        <span class="day-label">Thursday</span>
                        <span>Mapo Tofu</span>
                    </div>
                    <div class="meal-item">
                        <span class="day-label">Friday</span>
                        <span>Pasta Bolognese</span>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>üí™ Health Streak</h2>
                <div class="health-streak">
                    <div class="streak-number" id="streakNumber">0</div>
                    <div class="streak-label">days of movement</div>
                </div>
                <button class="btn" onclick="logWorkout()">Log Today's Movement</button>
            </div>

            <div class="card">
                <h2>üì¶ Amazon Deliveries</h2>
                <div id="amazonStatus">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                        <div class="status-dot" style="background: #95a5a6;"></div>
                        <span>Checking tracker...</span>
                    </div>
                </div>
                <div id="packageList" style="font-size: 14px;"></div>
                <div style="display: flex; gap: 8px; margin-top: 12px;">
                    <button class="btn" onclick="syncAmazon()" style="flex: 1; font-size: 14px;">üîÑ Sync Now</button>
                    <button class="btn" onclick="window.open('http://' + window.location.hostname + ':8090', '_blank')" style="flex: 1; font-size: 14px;">Full Dashboard</button>
                </div>
                <p style="font-size: 12px; color: #666; margin-top: 10px;">
                    Note: Requires local tracker running on port 8090
                </p>
            </div>

            <div class="card">
                <h2>‚Ü©Ô∏è Amazon Returns & Refunds</h2>
                <div id="returnsStatus">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                        <div class="status-dot" style="background: #95a5a6;"></div>
                        <span>Checking returns...</span>
                    </div>
                </div>
                <div id="returnsList" style="font-size: 14px;"></div>
                <div style="margin-top: 12px;">
                    <div style="display: flex; justify-content: space-between; font-size: 12px; color: #666; margin-bottom: 8px;">
                        <span>Total Refunded: <strong id="totalRefunded">$0</strong></span>
                        <span>Reversed: <strong id="totalReversed" style="color: #e74c3c;">$0</strong></span>
                    </div>
                    <div id="provisionalWarning" style="display: none; background: #fff3cd; padding: 10px; border-radius: 6px; font-size: 12px; color: #856404; margin-top: 8px;">
                        ‚ö†Ô∏è <span id="provisionalCount">0</span> provisional refund(s) - may still be reversed
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>üìù Quick Note</h2>
                <textarea class="quick-note" id="quickNote" placeholder="What's on your mind?"></textarea>
                <button class="btn" onclick="saveNote()">Save Note</button>
            </div>
        </div>

        <!-- Tasks Section -->
        <div id="tasks-section" class="section">
            <div class="card">
                <h2>üìù Tasks</h2>
                
                <div class="input-wrapper">
                    <input type="text" id="taskInput" placeholder="What needs to be done?">
                    <button class="btn" style="width: auto; margin-top: 0;" onclick="addTask()">Add</button>
                </div>

                <div class="filters">
                    <button class="filter-btn active" data-filter="all" onclick="setFilter('all')">All</button>
                    <button class="filter-btn" data-filter="active" onclick="setFilter('active')">Active</button>
                    <button class="filter-btn" data-filter="completed" onclick="setFilter('completed')">Done</button>
                </div>

                <div class="task-list" id="taskList">
                    <div class="empty-state">
                        <div style="font-size: 48px; margin-bottom: 16px;">üìù</div>
                        <div style="font-size: 18px; color: #666;">No tasks yet</div>
                        <p>Add a task above</p>
                    </div>
                </div>

                <div class="todo-stats">
                    <span id="itemsLeft">0 items left</span>
                    <span style="cursor: pointer; color: #667eea;" onclick="clearCompleted()">Clear completed</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Navigation
        function showSection(section) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            
            document.getElementById(section + '-section').classList.add('active');
            event.target.classList.add('active');
        }

        // Date
        const today = new Date();
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('todayDate').textContent = today.toLocaleDateString('en-US', options);

        // School Status
        const noSchoolDates = [
            '2026-02-14', '2026-02-15', '2026-02-16', '2026-02-17',
            '2026-02-23',
        ];
        
        const todayStr = today.toISOString().split('T')[0];
        const isNoSchool = noSchoolDates.includes(todayStr) || today.getDay() === 0 || today.getDay() === 6;
        
        if (isNoSchool) {
            document.getElementById('schoolStatus').innerHTML = 
                '<div class="status-dot noschool"></div><span>No school today</span>';
        }

        const nextEventDate = new Date('2026-02-14');
        const daysUntil = Math.ceil((nextEventDate - today) / (1000 * 60 * 60 * 24));
        document.getElementById('nextEvent').textContent = `Next: Presidents' Day Break in ${daysUntil} days`;

        // Health Streak
        let streak = parseInt(localStorage.getItem('healthStreak') || '0');
        document.getElementById('streakNumber').textContent = streak;

        function logWorkout() {
            streak++;
            localStorage.setItem('healthStreak', streak);
            document.getElementById('streakNumber').textContent = streak;
            alert('Great job! Streak updated.');
        }

        // Notes
        function saveNote() {
            const note = document.getElementById('quickNote').value;
            if (note.trim()) {
                const notes = JSON.parse(localStorage.getItem('quickNotes') || '[]');
                notes.push({ text: note, date: new Date().toISOString() });
                localStorage.setItem('quickNotes', JSON.stringify(notes));
                document.getElementById('quickNote').value = '';
                alert('Note saved!');
            }
        }

        // Tasks
        let tasks = JSON.parse(localStorage.getItem('tasks') || '[]');
        let currentFilter = 'all';

        function saveTasks() {
            localStorage.setItem('tasks', JSON.stringify(tasks));
            render();
        }

        function addTask() {
            const input = document.getElementById('taskInput');
            const text = input.value.trim();
            if (!text) return;

            tasks.push({
                id: Date.now(),
                text: text,
                completed: false
            });
            input.value = '';
            saveTasks();
        }

        function toggleTask(id) {
            const task = tasks.find(t => t.id === id);
            if (task) {
                task.completed = !task.completed;
                saveTasks();
            }
        }

        function deleteTask(id) {
            tasks = tasks.filter(t => t.id !== id);
            saveTasks();
        }

        function clearCompleted() {
            tasks = tasks.filter(t => !t.completed);
            saveTasks();
        }

        function setFilter(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            render();
        }

        function render() {
            let filtered = tasks;
            if (currentFilter === 'active') filtered = tasks.filter(t => !t.completed);
            if (currentFilter === 'completed') filtered = tasks.filter(t => t.completed);

            const activeCount = tasks.filter(t => !t.completed).length;
            document.getElementById('itemsLeft').textContent = `${activeCount} item${activeCount !== 1 ? 's' : ''} left`;

            const list = document.getElementById('taskList');
            
            if (filtered.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div style="font-size: 48px; margin-bottom: 16px;">üìù</div>
                        <div style="font-size: 18px; color: #666;">${currentFilter === 'completed' ? 'No completed tasks' : 'No tasks yet'}</div>
                    </div>`;
                return;
            }

            list.innerHTML = filtered.map(task => `
                <div class="task ${task.completed ? 'completed' : ''}">
                    <div class="task-checkbox ${task.completed ? 'checked' : ''}" onclick="toggleTask(${task.id})"></div>
                    <span class="task-text">${task.text}</span>
                    <button class="task-delete" onclick="deleteTask(${task.id})">Delete</button>
                </div>
            `).join('');
        }

        document.getElementById('taskInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addTask();
        });

        render();

        // Amazon Tracker Integration
        const AMAZON_API = 'http://localhost:8090';
        
        async function loadAmazonPackages() {
            try {
                const [statsRes, arrivingRes, pendingRes, recentRes] = await Promise.all([
                    fetch(AMAZON_API + '/api/stats'),
                    fetch(AMAZON_API + '/api/arriving-today'),
                    fetch(AMAZON_API + '/api/pending'),
                    fetch(AMAZON_API + '/api/recent-deliveries?days=7')
                ]);
                
                if (!statsRes.ok) throw new Error('Tracker not running');
                
                const stats = await statsRes.json();
                const arriving = await arrivingRes.json();
                const pending = await pendingRes.json();
                const recent = await recentRes.json();
                
                updateAmazonUI({
                    stats: stats,
                    arriving: arriving.orders || [],
                    pending: pending.orders || [],
                    recent: recent.orders || []
                });
            } catch (e) {
                document.getElementById('amazonStatus').innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div class="status-dot" style="background: #95a5a6;"></div>
                        <span>Tracker offline</span>
                    </div>
                    <p style="font-size: 13px; color: #666; margin-top: 8px;">
                        Local tracker not running on port 8090
                    </p>
                `;
                document.getElementById('packageList').innerHTML = '';
            }
        }
        
        async function syncAmazon() {
            const btn = document.querySelector('button[onclick="syncAmazon()"]');
            const originalText = btn.textContent;
            btn.textContent = '‚è≥ Syncing...';
            btn.disabled = true;
            
            try {
                const response = await fetch(AMAZON_API + '/api/sync', { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    btn.textContent = `‚úÖ +${result.new_orders} new`;
                    setTimeout(loadAmazonPackages, 1000);
                } else {
                    btn.textContent = '‚ùå Failed';
                }
            } catch (e) {
                btn.textContent = '‚ùå Error';
            }
            
            setTimeout(() => {
                btn.textContent = originalText;
                btn.disabled = false;
            }, 3000);
        }

        function updateAmazonUI(data) {
            const arriving = data.arriving || [];
            const pending = data.pending || [];
            const recent = data.recent || [];
            const stats = data.stats || {};
            
            let html = '';
            
            if (arriving.length > 0) {
                html += `<div style="background: #d4edda; padding: 12px; border-radius: 8px; margin-bottom: 12px; border-left: 4px solid #28a745;">`;
                html += `<strong style="color: #155724;">üöö Arriving Today (${arriving.length})</strong><br>`;
                arriving.slice(0, 2).forEach(order => {
                    const items = order.items?.map(i => i.name || i.item_name).join(', ') || 'Package';
                    html += `<span style="font-size: 13px;">‚Ä¢ ${items.substring(0, 35)}${items.length > 35 ? '...' : ''}</span><br>`;
                });
                if (arriving.length > 2) {
                    html += `<span style="font-size: 12px; color: #155724;">+${arriving.length - 2} more</span>`;
                }
                html += `</div>`;
            }
            
            if (pending.length > 0) {
                html += `<div style="margin-bottom: 12px;">`;
                html += `<strong style="color: #0c5460;">üì¶ In Transit (${pending.length})</strong><br>`;
                pending.slice(0, 2).forEach(order => {
                    const items = order.items?.map(i => i.name || i.item_name).join(', ') || 'Order';
                    const eta = order.delivery_date ? ` (ETA: ${formatDate(order.delivery_date)})` : '';
                    html += `<span style="font-size: 13px; color: #666;">‚Ä¢ ${items.substring(0, 30)}${items.length > 30 ? '...' : ''}${eta}</span><br>`;
                });
                if (pending.length > 2) {
                    html += `<span style="font-size: 12px; color: #888;">+${pending.length - 2} more pending</span>`;
                }
                html += `</div>`;
            }
            
            if (recent.length > 0) {
                html += `<div style="color: #27ae60;">`;
                html += `<strong>‚úì Delivered This Week (${recent.length})</strong>`;
                if (stats.total_spent > 0) {
                    html += `<span style="color: #666; font-size: 13px; margin-left: 8px;">($${stats.total_spent.toFixed(0)} spent)</span>`;
                }
                html += `</div>`;
            }
            
            document.getElementById('packageList').innerHTML = html || '<p style="color: #666;">No active packages</p>';
            
            const statusColor = arriving.length > 0 ? '#ffc107' : pending.length > 0 ? '#17a2b8' : '#28a745';
            const statusText = arriving.length > 0 
                ? `${arriving.length} arriving today` 
                : pending.length > 0 
                    ? `${pending.length} in transit` 
                    : recent.length > 0 
                        ? 'All delivered' 
                        : 'No active packages';
            
            document.getElementById('amazonStatus').innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div class="status-dot" style="background: ${statusColor};"></div>
                    <span>${statusText}</span>
                </div>
            `;
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            if (date.toDateString() === today.toDateString()) return 'Today';
            if (date.toDateString() === tomorrow.toDateString()) return 'Tomorrow';
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        // Load Amazon packages on page load
        loadAmazonPackages();
        
        // Auto-refresh every 60 seconds
        setInterval(loadAmazonPackages, 60000);

        // Amazon Returns Integration
        async function loadAmazonReturns() {
            try {
                const [statsRes, activeRes, provisionalRes, reversedRes] = await Promise.all([
                    fetch(AMAZON_API + '/api/stats'),
                    fetch(AMAZON_API + '/api/returns/active'),
                    fetch(AMAZON_API + '/api/returns/provisional'),
                    fetch(AMAZON_API + '/api/returns/reversed')
                ]);
                
                if (!statsRes.ok) throw new Error('Tracker not running');
                
                const stats = await statsRes.json();
                const active = await activeRes.json();
                const provisional = await provisionalRes.json();
                const reversed = await reversedRes.json();
                
                updateReturnsUI({
                    return_stats: stats.return_stats || {},
                    active: active.returns || [],
                    provisional: provisional.returns || [],
                    reversed: reversed.returns || []
                });
            } catch (e) {
                document.getElementById('returnsStatus').innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div class="status-dot" style="background: #95a5a6;"></div>
                        <span>Tracker offline</span>
                    </div>
                `;
                document.getElementById('returnsList').innerHTML = '';
            }
        }

        function updateReturnsUI(data) {
            const stats = data.return_stats || {};
            const active = data.active || [];
            const provisional = data.provisional || [];
            const reversed = data.reversed || [];
            
            // Update totals
            document.getElementById('totalRefunded').textContent = '$' + (stats.total_refunded || 0).toFixed(0);
            document.getElementById('totalReversed').textContent = '$' + (stats.total_reversed || 0).toFixed(0);
            
            // Show provisional warning if applicable
            const provCount = provisional.length;
            const provWarning = document.getElementById('provisionalWarning');
            if (provCount > 0) {
                provWarning.style.display = 'block';
                document.getElementById('provisionalCount').textContent = provCount;
            } else {
                provWarning.style.display = 'none';
            }
            
            let html = '';
            
            // Show reversed refunds (most important - money was taken back!)
            if (reversed.length > 0) {
                html += `<div style="background: #f8d7da; padding: 12px; border-radius: 8px; margin-bottom: 12px; border-left: 4px solid #dc3545;">`;
                html += `<strong style="color: #721c24;">‚ö†Ô∏è Reversed Refunds (${reversed.length})</strong><br>`;
                html += `<span style="font-size: 12px; color: #856404;">Amazon took back these refunds</span><br>`;
                reversed.slice(0, 2).forEach(ret => {
                    const item = ret.item_name || 'Item';
                    const amount = ret.refund_amount ? `$${ret.refund_amount.toFixed(2)}` : '';
                    const reason = ret.reversal_reason ? ` - ${ret.reversal_reason}` : '';
                    html += `<span style="font-size: 13px;">‚Ä¢ ${item.substring(0, 30)}${item.length > 30 ? '...' : ''} ${amount}${reason}</span><br>`;
                });
                if (reversed.length > 2) {
                    html += `<span style="font-size: 12px; color: #721c24;">+${reversed.length - 2} more reversed</span>`;
                }
                html += `</div>`;
            }
            
            // Show provisional refunds (watch these - may be reversed)
            if (provisional.length > 0) {
                html += `<div style="background: #fff3cd; padding: 12px; border-radius: 8px; margin-bottom: 12px; border-left: 4px solid #ffc107;">`;
                html += `<strong style="color: #856404;">‚è≥ Provisional Refunds (${provisional.length})</strong><br>`;
                html += `<span style="font-size: 12px; color: #856404;">Within 30 days - may still be reversed</span><br>`;
                provisional.slice(0, 2).forEach(ret => {
                    const item = ret.item_name || 'Item';
                    const amount = ret.refund_amount ? `$${ret.refund_amount.toFixed(2)}` : '';
                    html += `<span style="font-size: 13px;">‚Ä¢ ${item.substring(0, 30)}${item.length > 30 ? '...' : ''} ${amount}</span><br>`;
                });
                if (provisional.length > 2) {
                    html += `<span style="font-size: 12px; color: #856404;">+${provisional.length - 2} more provisional</span>`;
                }
                html += `</div>`;
            }
            
            // Show active returns
            if (active.length > 0) {
                const nonProvisional = active.filter(r => !provisional.find(p => p.return_id === r.return_id));
                if (nonProvisional.length > 0) {
                    html += `<div style="margin-bottom: 12px;">`;
                    html += `<strong style="color: #0c5460;">üîÑ Active Returns (${nonProvisional.length})</strong><br>`;
                    nonProvisional.slice(0, 2).forEach(ret => {
                        const item = ret.item_name || 'Item';
                        const status = ret.return_status ? `(${ret.return_status})` : '';
                        html += `<span style="font-size: 13px; color: #666;">‚Ä¢ ${item.substring(0, 30)}${item.length > 30 ? '...' : ''} ${status}</span><br>`;
                    });
                    if (nonProvisional.length > 2) {
                        html += `<span style="font-size: 12px; color: #888;">+${nonProvisional.length - 2} more</span>`;
                    }
                    html += `</div>`;
                }
            }
            
            document.getElementById('returnsList').innerHTML = html || '<p style="color: #666;">No active returns</p>';
            
            // Status dot
            let statusColor = '#28a745';
            let statusText = 'All returns complete';
            
            if (reversed.length > 0) {
                statusColor = '#dc3545';
                statusText = `${reversed.length} refund(s) reversed!`;
            } else if (provisional.length > 0) {
                statusColor = '#ffc107';
                statusText = `${provisional.length} provisional refund(s)`;
            } else if (active.length > 0) {
                statusColor = '#17a2b8';
                statusText = `${active.length} return(s) in progress`;
            }
            
            document.getElementById('returnsStatus').innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div class="status-dot" style="background: ${statusColor};"></div>
                    <span>${statusText}</span>
                </div>
            `;
        }

        // Load returns on page load
        loadAmazonReturns();
        
        // Auto-refresh returns every 60 seconds
        setInterval(loadAmazonReturns, 60000);
    </script>
</body>
</html>
